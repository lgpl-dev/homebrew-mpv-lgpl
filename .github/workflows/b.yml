name: "Release Bottles"

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-release:
    strategy:
      matrix:
        os: [macos-15, macos-14, macos-13]
        arch: [arm64, x86_64]
        exclude:
          - os: macos-15
            arch: x86_64
      fail-fast: false
    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for existing bottle on release
        id: check_bottle
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          FORMULA_NAME="mpv-lgpl"
          FORMULA_FILE="mpv-lgpl.rb"
          
          if [ ! -f "$FORMULA_FILE" ]; then
            echo "::error::Formula file '$FORMULA_FILE' not found."
            exit 1
          fi

          # `bottle do`ブロック内の`root_url`からバージョンを抽出
          # この方法が、ビルドされたバイナリのバージョンと最も一致します
          FORMULA_TAG=$(grep 'root_url ' "$FORMULA_FILE" | grep -o 'v[0-9.]*_[0-9.]*' | sed 's/^v//' | tr -d '\n' || true)
          if [[ -z "$FORMULA_TAG" ]]; then
            echo "::warning::Could not determine formula tag from 'root_url'. Using fallback."
            FORMULA_TAG="0.40.0"
          fi
          
          # タグからバージョンとリビジョンを分離
          if [[ "$FORMULA_TAG" == *_* ]]; then
            FORMULA_VERSION=$(echo "$FORMULA_TAG" | cut -d'_' -f1)
            FORMULA_REVISION=$(echo "$FORMULA_TAG" | cut -d'_' -f2)
          else
            FORMULA_VERSION=$FORMULA_TAG
            FORMULA_REVISION="0"
          fi
          
          # リリースタグを生成
          if [ "$FORMULA_REVISION" == "0" ]; then
            RELEASE_TAG="v$FORMULA_VERSION"
          else
            RELEASE_TAG="v${FORMULA_VERSION}_${FORMULA_REVISION}"
          fi
          
          OS_VERSION="${{ matrix.os }}"
          if [ "$OS_VERSION" == "macos-15" ]; then
            OS_TAG="sequoia"
          elif [ "$OS_VERSION" == "macos-14" ]; then
            OS_TAG="sonoma"
          elif [ "$OS_VERSION" == "macos-13" ]; then
            OS_TAG="ventura"
          else
            OS_TAG=$(echo "$OS_VERSION" | sed 's/macos-//')
          fi

          ARCH_TAG="${{ matrix.arch }}"

          if [ "$ARCH_TAG" == "arm64" ]; then
              ARCH_PREFIX="${ARCH_TAG}_"
          else
              ARCH_PREFIX=""
          fi
          
          # ファイル名を生成。リビジョンが0の場合は'_0'を含めない。
          if [ "$FORMULA_REVISION" == "0" ]; then
            FILE_NAME="${FORMULA_NAME}-${FORMULA_VERSION}.${ARCH_PREFIX}${OS_TAG}.bottle.tar.gz"
          else
            FILE_NAME="${FORMULA_NAME}-${FORMULA_VERSION}_${FORMULA_REVISION}.${ARCH_PREFIX}${OS_TAG}.bottle.tar.gz"
          fi
          
          FILE_NAME=$(echo "$FILE_NAME" | sed 's/--/-/g')
          
          echo "Expected file: $FILE_NAME"
          echo "Expected release tag: $RELEASE_TAG"
          
          RELEASE_ASSETS=$(gh release view "$RELEASE_TAG" --json assets 2>/dev/null || true)
          
          if [[ "$RELEASE_ASSETS" == *"$FILE_NAME"* ]]; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
            echo "--- Bottle for this configuration already exists. Skipping build and upload. ---"
          else
            echo "skip=false" >> "$GITHUB_OUTPUT"
            echo "--- Bottle does not exist. Proceeding with build. ---"
          fi
